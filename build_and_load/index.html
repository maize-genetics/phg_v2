<!-- Elements added to main will be displayed on all pages -->

<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Pangenome system for plant breeding and genetics">
      
      
        <meta name="author" content="Buckler Lab">
      
      
        <link rel="canonical" href="https://phg.maizegenetics.net/build_and_load/">
      
      
        <link rel="prev" href="../installation/">
      
      
        <link rel="next" href="../imputation_ropebwt/">
      
      
      <link rel="icon" href="../img/product/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Building and loading - Practical Haplotype Graph</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#building-and-loading" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Practical Haplotype Graph" class="md-header__button md-logo" aria-label="Practical Haplotype Graph" data-md-component="logo">
      
  <img src="../img/product/phg_logo_white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Practical Haplotype Graph
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Building and loading
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/maize-genetics/phg_v2" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    PHGv2
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href=".." class="md-tabs__link">
          
  
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../installation/" class="md-tabs__link">
          
  
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../hvcf_specifications/" class="md-tabs__link">
          
  
  
    
  
  Reference

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../citations/" class="md-tabs__link">
          
  
  
    
  
  Community

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Practical Haplotype Graph" class="md-nav__button md-logo" aria-label="Practical Haplotype Graph" data-md-component="logo">
      
  <img src="../img/product/phg_logo_white.svg" alt="logo">

    </a>
    Practical Haplotype Graph
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/maize-genetics/phg_v2" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    PHGv2
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href=".." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Building and loading
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Building and loading
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      Quick start
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detailed-walkthrough" class="md-nav__link">
    <span class="md-ellipsis">
      Detailed walkthrough
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Detailed walkthrough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preamble" class="md-nav__link">
    <span class="md-ellipsis">
      Preamble
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-conda-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Set up Conda environment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-phg-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Running phg commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialize-tiledb-instances" class="md-nav__link">
    <span class="md-ellipsis">
      Initialize TileDB instances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-assembly-fasta-files" class="md-nav__link">
    <span class="md-ellipsis">
      Prepare Assembly FASTA files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compress-fasta-files" class="md-nav__link">
    <span class="md-ellipsis">
      Compress FASTA files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-reference-ranges" class="md-nav__link">
    <span class="md-ellipsis">
      Create reference ranges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#align-assemblies" class="md-nav__link">
    <span class="md-ellipsis">
      Align assemblies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Align assemblies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#align-assemblies-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Align-assemblies parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#align-assemblies-optional-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Align-assemblies optional parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-anchorwave-and-minimap2-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Internal AnchorWave and minimap2 commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#details-threads-and-parallelization" class="md-nav__link">
    <span class="md-ellipsis">
      Details - threads and parallelization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-vcf-files" class="md-nav__link">
    <span class="md-ellipsis">
      Create VCF files
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create VCF files">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inputs-for-the-create-ref-vcf-command" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs for the create-ref-vcf command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inputs-for-the-create-maf-vcf-command" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs for the create-maf-vcf command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inputs-for-the-gvcf2hvcf-command-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs for the gvcf2hvcf command (OPTIONAL!)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-vcf-data-into-dbs" class="md-nav__link">
    <span class="md-ellipsis">
      Load VCF data into DBs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#where-to-go-from-here" class="md-nav__link">
    <span class="md-ellipsis">
      Where to go from here?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Imputation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Imputation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../imputation_ropebwt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RopeBWT3 Imputation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../imputation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    k-mer Imputation (Deprecated)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../resequencing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Resequencing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../export_data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exporting data
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Specifications
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Specifications
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hvcf_specifications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    hVCF specifications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ktor_specifications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ktor specifications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ps4g_specifications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PS4G specifications
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Optional commands
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Optional commands
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../convenience_commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Convenience commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../qc_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    QC metrics
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Miscellaneous articles
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Miscellaneous articles
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hvcf_region_handling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    hVCF region handling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../slurm_usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SLURM usage for alignment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../terminology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Terminology
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../variant_comparisons/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Variant caller comparisons
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Community
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Community
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../citations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    References
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CODE_OF_CONDUCT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code of Conduct
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      Quick start
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detailed-walkthrough" class="md-nav__link">
    <span class="md-ellipsis">
      Detailed walkthrough
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Detailed walkthrough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preamble" class="md-nav__link">
    <span class="md-ellipsis">
      Preamble
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-conda-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Set up Conda environment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-phg-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Running phg commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialize-tiledb-instances" class="md-nav__link">
    <span class="md-ellipsis">
      Initialize TileDB instances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-assembly-fasta-files" class="md-nav__link">
    <span class="md-ellipsis">
      Prepare Assembly FASTA files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compress-fasta-files" class="md-nav__link">
    <span class="md-ellipsis">
      Compress FASTA files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-reference-ranges" class="md-nav__link">
    <span class="md-ellipsis">
      Create reference ranges
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#align-assemblies" class="md-nav__link">
    <span class="md-ellipsis">
      Align assemblies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Align assemblies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#align-assemblies-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Align-assemblies parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#align-assemblies-optional-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Align-assemblies optional parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-anchorwave-and-minimap2-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Internal AnchorWave and minimap2 commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#details-threads-and-parallelization" class="md-nav__link">
    <span class="md-ellipsis">
      Details - threads and parallelization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-vcf-files" class="md-nav__link">
    <span class="md-ellipsis">
      Create VCF files
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create VCF files">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inputs-for-the-create-ref-vcf-command" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs for the create-ref-vcf command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inputs-for-the-create-maf-vcf-command" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs for the create-maf-vcf command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inputs-for-the-gvcf2hvcf-command-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Inputs for the gvcf2hvcf command (OPTIONAL!)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-vcf-data-into-dbs" class="md-nav__link">
    <span class="md-ellipsis">
      Load VCF data into DBs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#where-to-go-from-here" class="md-nav__link">
    <span class="md-ellipsis">
      Where to go from here?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="building-and-loading">Building and Loading<a class="headerlink" href="#building-and-loading" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As of version 2.4.X, the PHG utilizes a new version of AnchorWave
(<a href="https://github.com/baoxingsong/AnchorWave/releases/tag/v1.2.3">1.2.3</a>). 
This changes how ASM coordinates are handled. If you are using old 
MAF files generated either from AnchorWave 1.2.2 or from PHGv2 
version 2.3 or earlier, please use the <code>--legacy-maf-file</code> flag 
for the <code>create-maf-vcf</code> command. <strong>It is recommended</strong> that you 
remove your <code>phgv2-conda</code> Conda environment and rerun the 
<code>setup-environment</code> command.</p>
</div>
<p>In this document, we will discuss the steps needed to:</p>
<ol>
<li>Set up a working Conda environment containing the required
   external software</li>
<li>Initialize a <a href="https://docs.tiledb.com/main/integrations-and-extensions/genomics/population-genomics">TileDB-VCF</a> instance</li>
<li>Build VCF data</li>
<li>Loading data into TileDB-VCF instances</li>
</ol>
<h2 id="quick-start">Quick start<a class="headerlink" href="#quick-start" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>Set up the PHGv2 Conda environment:
    <div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>phg<span class="w"> </span>setup-environment
</span></code></pre></div></p>
</li>
<li>
<p>Initialize TileDB instances:
    <div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>phg<span class="w"> </span>initdb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span>--db-path<span class="w"> </span>/path/to/dbs
</span></code></pre></div></p>
</li>
<li>
<p>Update FASTA headers with sample information:
    <div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>phg<span class="w"> </span>prepare-assemblies<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span>--keyfile<span class="w"> </span>/path/to/keyfile<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span>--output-dir<span class="w"> </span>/path/to/updated/fastas<span class="w"> </span><span class="se">\</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span>--threads<span class="w"> </span><span class="m">10</span>
</span></code></pre></div></p>
</li>
<li>
<p>Create BED file from GFF for reference range coordinates:
    <div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>phg<span class="w"> </span>create-ranges<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span>--reference-file<span class="w"> </span>/path/to/updated/fastas/ref.fasta<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span>--gff<span class="w"> </span>/path/to/my.gff<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span>--boundary<span class="w"> </span>gene<span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span>--pad<span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span>--range-min-size<span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span>-o<span class="w"> </span>/path/to/ranges.bed
</span></code></pre></div></p>
</li>
<li>
<p>Align assemblies:
    <div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>phg<span class="w"> </span>align-assemblies<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span>--gff<span class="w"> </span>/path/to/my.gff<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span>--reference-file<span class="w"> </span>/path/to/updated/fastas/ref.fasta<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span>--assembly-file-list<span class="w"> </span>/path/to/assemblies_list.txt<span class="w"> </span><span class="se">\</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span>-o<span class="w"> </span>/path/to/maf_files
</span></code></pre></div></p>
</li>
<li>
<p>Compress FASTA files
    <div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>phg<span class="w"> </span>agc-compress<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span>--db-path<span class="w"> </span>/path/to/dbs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span>--reference-file<span class="w"> </span>/path/to/updated/fastas/ref.fasta<span class="w"> </span><span class="se">\</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span>--fasta-list<span class="w"> </span>/path/to/assemblies_list.txt
</span></code></pre></div></p>
</li>
<li>Create VCF files
    <div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># Reference VCF</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>phg<span class="w"> </span>create-ref-vcf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span>--bed<span class="w"> </span>/path/to/ranges.bed<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">    </span>--reference-file<span class="w"> </span>/path/to/updated/ref.fasta<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span>--reference-name<span class="w"> </span>B73<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">    </span>--db-path<span class="w"> </span>/path/to/dbs
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="c1"># MAF alignments to VCF</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>phg<span class="w"> </span>create-maf-vcf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span>--db-path<span class="w"> </span>/path/to/dbs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span>--bed<span class="w"> </span>/path/to/ranges.bed<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span>--reference-file<span class="w"> </span>/path/to/updated/ref.fasta<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span>--maf-dir<span class="w"> </span>/path/to/maf_files<span class="w"> </span><span class="se">\</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">    </span>-o<span class="w"> </span>/path/to/vcf_files
</span></code></pre></div></li>
<li>Load data into DBs
    <div class="language-shell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>phg<span class="w"> </span>load-vcf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span>--vcf-dir<span class="w"> </span>/path/to/vcf_files<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span>--db-path<span class="w"> </span>/path/to/dbs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span>--threads<span class="w"> </span><span class="m">10</span>
</span></code></pre></div></li>
</ul>
<h2 id="detailed-walkthrough">Detailed walkthrough<a class="headerlink" href="#detailed-walkthrough" title="Permanent link">&para;</a></h2>
<h3 id="preamble">Preamble<a class="headerlink" href="#preamble" title="Permanent link">&para;</a></h3>
<p>For the following steps, I will first make an example directory to
house our toy input data. The overall structure of the directory
looks like the following</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>phg_v2_example/
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>├── data
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>└── output
</span></code></pre></div>
<p>For the following steps, I will be using example small sequence
data from the <a href="https://github.com/maize-genetics/phg_v2/tree/main/data/test/smallseq">PHGv2 GitHub repository</a>.
This is a collection of small raw sequence files that
we use for pipeline testing. These will be placed in the <code>data</code>
subdirectory while files created by this pipeline will be placed in
the <code>output</code> subdirectory. Here, I have downloaded the following 
FASTA files:</p>
<ul>
<li><code>Ref.fa</code></li>
<li><code>LineA.fa</code></li>
<li><code>LineB.fa</code></li>
</ul>
<p>...and have renamed and placed them (which is needed to highlight the 
functionality of the <a href="#prepare-assembly-fasta-files">"Prepare Assembly FASTA Files"</a>
section later) in the <code>data/</code> directory. </p>
<p>Additionally, I have downloaded a GFF file called <code>anchors.gff</code> 
which will be used for the <a href="#create-reference-ranges">"Create Reference Ranges"</a>
and <a href="#align-assemblies">"Align Assemblies"</a> steps. Overall, my example
working directory now looks like the following:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>phg_v2_example/
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>├── data
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>│   ├── anchors.gff
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>│   ├── Ref-v5.fa
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>│   ├── LineA-final-01.fa
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>│   └── LineB-final-04.fa
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>└── output
</span></code></pre></div>
<p>This documentation will also assume that the PHGv2 application is 
placed in your system's <code>PATH</code> variable (<em>see the <a href="../installation/">installation 
documentation</a> for further details</em>).</p>
<h3 id="set-up-conda-environment">Set up Conda environment<a class="headerlink" href="#set-up-conda-environment" title="Permanent link">&para;</a></h3>
<p>Once you have downloaded the latest release of PHGv2 and have Conda 
installed (<em>see the <a href="../installation/">installation</a> documentation</em>), 
you will first need to set up a Conda environment to accommodate the 
necessary pieces of software for alignment, compression, and storage. 
Here is a list of essential pieces of software that will be installed 
in your Conda environment:</p>
<table>
<thead>
<tr>
<th>Software</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>agc</td>
<td>Performant FASTA genome compression</td>
</tr>
<tr>
<td>AnchorWave</td>
<td>Sensitive aligner for genomes with high sequence diversity</td>
</tr>
<tr>
<td>bcftools</td>
<td>Utilities for indexing VCF data</td>
</tr>
<tr>
<td>samtools</td>
<td>bgzip compression for VCF data</td>
</tr>
<tr>
<td>TileDB</td>
<td>Performant storage core for array data</td>
</tr>
<tr>
<td>TileDB-VCF</td>
<td>API for storing and querying VCF data</td>
</tr>
</tbody>
</table>
<p>Instead of setting this up manually, we can use the 
<code>setup-environment</code> command which will automate this process. To
run, use the following command:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>phg<span class="w"> </span>setup-environment
</span></code></pre></div>
<p>By using the prior default example, the <code>setup-environment</code> command 
will extract an internal Conda environment file with the necessary 
libraries and programs (<em>see following code block for example file</em>). 
<em>Optionally</em>, if you want to add additional libraries and programs 
to your PHGv2 Conda environment, you may specify the <em>optional</em> 
parameter, <code>--env-file</code>. This will be a path to a <em>local</em> Conda 
environment file. You can create the file from scratch (for example, 
I will call mine <code>phg_environment.yml</code>) and copy over the contents 
in the following block:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>name: phgv2-conda
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>channels:
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>  - conda-forge
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>  - bioconda
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>  - tiledb
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>dependencies:
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>  - python=3.8
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>  - tiledb-py=0.22
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>  - tiledbvcf-py=0.25
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>  - anchorwave=1.2.3
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>  - bcftools
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>  - samtools
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>  - agc
</span></code></pre></div>
<p>Another option is to pull in the environment file directly from the 
<a href="https://github.com/maize-genetics/phg_v2">GitHub repository</a>:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>curl<span class="w"> </span>https://raw.githubusercontent.com/maize-genetics/phg_v2/main/src/main/resources/phg_environment.yml<span class="w"> </span>-o<span class="w"> </span>phg_environment.yml
</span></code></pre></div>
<p>Once the local YAML file is made, we can pass it to the <code>--env-file</code>
parameter:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>phg<span class="w"> </span>setup-environment<span class="w"> </span>--env-file<span class="w"> </span>phg_environment.yml
</span></code></pre></div>
<p>After the setup step is complete, we can activate our environment
using the following conda command:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>conda<span class="w"> </span>activate<span class="w"> </span>phgv2-conda
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is imperative the Conda environment you create is named 
<code>phgv2-conda</code>. This is the default environment name that PHGv2 uses 
when executing shell commands from within the software.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This environment will change as new versions of the software are
released. It is recommended to delete any existing phgv2-conda
environments and recreate it using the <code>setup-environment</code> 
command.  In particular with PHGv2.4, <code>anchorwave</code> is updated to 1.2.3 which represents a fundamental shift in how ASM coordinates are handled. </p>
</div>
<p>If we look in our example project directory, you will also see two
new logging (<code>.log</code>) files which will record all the logging and
error output from the PHGv2 command steps:</p>
<ul>
<li><code>condaCreate_error.log</code></li>
<li><code>condaCreate_output.log</code></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you need or want to have the Conda environment setup in a non-default
location, you must run the <code>conda env create</code> command manually
using the <code>--prefix</code> option to specify the name and location of the
environment.  This created location should then be passed as the
<code>conda-env-prefix</code> parameter for all PHGv2 commands that have this optional
parameter.  For this scenario, the <code>.yml</code> file <strong>should not contain the 
<code>name:</code></strong> section.  An example of the command to create the environment in a
non-default location is:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>conda<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>--prefix<span class="w"> </span>/path/to/new/conda/env<span class="w"> </span>--file<span class="w"> </span>phg_environment.yml
</span></code></pre></div>
</div>
<h3 id="running-phg-commands">Running phg commands<a class="headerlink" href="#running-phg-commands" title="Permanent link">&para;</a></h3>
<p>PHGv2 has several commands that specify an output directory. This is 
depicted as either <code>-o</code> or <code>--output-dir</code> for the parameter names. 
<strong>Please make sure that these directories exist in your project 
before running any commands that require the <code>-o</code> or <code>--output-dir</code> 
field</strong>!</p>
<p>Additionally, the <code>--db-path</code> parameter shows up in many of the PHGv2 
commands. It is the path to the directory where the TileDB datasets 
are stored. This parameter is an optional parameter for all commands 
in which it appears.  If a folder is not specified for the 
<code>--db-path</code>, the software will use the current working directory. 
When TileDB datasets are required for processing, the <code>--db-path</code> 
parameter value will be verified to ensure the required datasets are 
present. If they are not present in the <code>--db-path</code> folder (or in the 
current working directory) the software with throw an exception.</p>
<p>Finally, several commands have the optional parameter `conda-env-prefix'.
This parameter is used to specify the location of the conda environment
when it is not in the default location and/or is named differently than
the default name of 'phgv2-conda'.  If you are using the default conda 
environment name and location, you do not need to specify this parameter.</p>
<h3 id="initialize-tiledb-instances">Initialize TileDB instances<a class="headerlink" href="#initialize-tiledb-instances" title="Permanent link">&para;</a></h3>
<p>In PHGv2, we leverage <a href="https://tiledb.com/">TileDB</a> and 
<a href="https://docs.tiledb.com/main/integrations-and-extensions/genomics/population-genomics">TileDB-VCF</a> 
for efficient storage and querying of VCF data. For downstream 
pipelines, we will need to initialize 2 databases for storing different
VCF information: (1) haplotype (hVCF) and (2) genomic variant (gVCF) 
information.</p>
<p>Similar to setting
up our Conda environment from the prior section, we can automate this
process using the <code>initdb</code> command:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>./phg<span class="w"> </span>initdb<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span>--db-path<span class="w"> </span>vcf_dbs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span>--gvcf-anchor-gap<span class="w"> </span><span class="m">1000000</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span>--hvcf-anchor-gap<span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span>--conda-env-prefix<span class="w"> </span>/path/to/conda/env
</span></code></pre></div>
<p>This command takes one required parameter, <code>--db-path</code> which is the 
path or subdirectory to where we want to place our databases. In this
example project, I will initialize the hVCF and gVCF database 
folders in a subdirectory called <code>vcf_dbs</code>.</p>
<p>Three optional parameters may also be set.</p>
<p>Parameters <code>--gvcf-anchor-gap</code> and <code>--hvcf-anchor-gap</code>
define the distance between anchors
in the two TileDB-VCF sparse arrays. Smaller values enable faster
data retrieval. However, if there are non-symbolic variants that span
many anchors (for example, very large deletions), then the <code>load-vcf</code>
command will require a large amount of RAM to process variant
information for each assembly. More information can be found in the
<a href="https://tiledb-inc.github.io/TileDB-VCF/documentation/the-solution.html">TileDB-VCF docs.</a></p>
<p>Optional parameter <code>--conda-env-prefix</code> is the path to the Conda env directory
that contains the conda environment needed to run phg. This parameter is
used when the conda environment to activate does not reside in the default
location.</p>
<p>After initialization is complete, we will have two empty TileDB-VCF
instances and a <code>temp</code> directory in our <code>vcf_dbs</code> subdirectory:</p>
<table>
<thead>
<tr>
<th>Directory</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gvcf_dataset</code></td>
<td>Genomic variant (gVCF) database storage</td>
</tr>
<tr>
<td><code>hvcf_dataset</code></td>
<td>Haplotype variant (hVCF) database storage</td>
</tr>
<tr>
<td><code>temp</code></td>
<td>Creation output and error logging files</td>
</tr>
</tbody>
</table>
<p>For reference, my example working directory now looks like this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>phg_v2_example/
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>├── data
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>│   ├── anchors.gff
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>│   ├── Ref-v5.fa
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>│   ├── LineA-final-01.fa
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>│   └── LineB-final-04.fa
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>├── output
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>└── vcf_dbs *
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    ├── gvcf_dataset/ *
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    ├── hvcf_dataset/ *
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    └── temp/ *
</span></code></pre></div>
<h3 id="prepare-assembly-fasta-files">Prepare Assembly FASTA files<a class="headerlink" href="#prepare-assembly-fasta-files" title="Permanent link">&para;</a></h3>
<p>Before we begin our alignment and VCF creation steps, we must first
process our "raw" FASTA files. This section will accomplish two
goals:</p>
<ol>
<li>Copy and rename FASTA files via user-provided sample name IDs.</li>
<li>Add a sample name tag to the ID lines of each FASTA file.</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Updated assembly <strong>and</strong> reference FASTA files will need to
be used as input for all downstream commands that take assembly 
or reference FASTA files as input (e.g., <code>agc-compress</code>, 
<code>align-assemblies</code>, etc.). This ensures consistent sample names 
across the pipeline!</p>
</div>
<p>To better explain the first goal, let's use an example. A file named
<code>Zm-CML52-NAM-1.0.fa</code> would be copied to a new one named <code>CML52.fa</code>.
This action is based on a keyfile (<em>which we will discuss later in the
parameters section</em>) provided by the user. The keyfile would list
"CML52" as the sample name for this FASTA shown below:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>## A keyfile example (disregard &#39;#&#39; comments for your actual keyfile):
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a># file name           # new name
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>Zm-CML52-NAM-1.0.fa   CML52
</span></code></pre></div>
<p>The reason for this change is the AGC compression tool stores the
file name (minus extension) as the sample name when creating the
compressed file.  This keeps the AGC sample name consistent with
sample names that are stored in the VCF files. With consistent sample
names, sequence and variants may be associated.</p>
<p>For the second goal: As of the current date of this document, the
return methods of AGC will not keep track of sample IDs when returning
sequence information from the compressed file <strong>unless you explicitly
state the sample information in the header lines of the FASTA files
you wish to compress for the PHGv2 databases</strong>.</p>
<p>To explain this
further, let's imagine that we have two FASTA files: <code>LineA.fa</code> and
<code>LineB.fa</code>. These files contain information for only chromosome 1 and
have a simple header that denotes this sequence name (e.g. <code>chr1</code>):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>$ head LineA.fa
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>&gt;chr1
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>ATGCGTACGCGCACCG
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>$ head LineB.fa
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>&gt;chr1
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>ATGCGTTCGCCTTCCG
</span></code></pre></div>
<p>After we compress this information using the <code>agc-compress</code> command,
we will have a file called <code>assemblies.agc</code>. PHGv2 leverages this
compressed sequence file when creating VCF data (<em>see
the <a href="#create-vcf-files">"Create VCF files"</a> section for further
details</em>). The issue arrives when we query the compressed data using
<a href="https://github.com/refresh-bio/agc#extract-contigs-from-the-archive">AGC's <code>getctg</code></a>
command. When we query this example archive, we will get the
following information:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>$ agc getctg assemblies.agc chr1@LineA chr1@LineB &gt; queries.fa
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>$ cat queries.fa
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>&gt;chr1
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>ATGCGTACGCGCACCG
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>&gt;chr1
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>ATGCGTTCGCCTTCCG
</span></code></pre></div>
<p>As you can see from the above example output, we now have no
means to efficiently track where each sequence is coming from due
to the lack of header information from our prior FASTA files. We
can remedy this by adding sample information to the headers:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>$ head LineA.fa
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>&gt;chr1 sampleName=LineA
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>ATGCGTACGCGCACCG
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>$ head LineB.fa
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>&gt;chr1 sampleName=LineB
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>ATGCGTTCGCCTTCCG
</span></code></pre></div>
<p>Now, when we compress and query using AGC, we get enhanced sample ID
tracking:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>$ ./agc getctg assemblies_new_headers.agc chr1@LineA chr1@LineB &gt; queries.fa
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>$ head queries.fa
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>&gt;chr1 sampleName=LineA
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>ATGCGTACGCGCACCG
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>&gt;chr1 sampleName=LineB
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>ATGCGTTCGCCTTCCG
</span></code></pre></div>
<p>While we can manually modify the header lines of our FASTA
file, this can become tedious and prone to a new set of downstream
errors. To automate this, PHGv2 provides a command to append sample
information to the headers of each FASTA file called
<code>prepare-assemblies</code>:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>phg<span class="w"> </span>prepare-assemblies<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span>--keyfile<span class="w"> </span>data/annotation_keyfile.txt<span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">    </span>--threads<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span>--output-dir<span class="w"> </span>output/updated_assemblies
</span></code></pre></div>
<p>This command takes 3 parameters:</p>
<ul>
<li>
<p><code>--keyfile</code> - A <a href="https://en.wikipedia.org/wiki/Tab-separated_values">tab-delimited</a>
  keyfile containing two columns:</p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1</code></td>
<td>Path to FASTA file you would like annotated (this is similar to the text files used to point to the FASTA file paths in the <a href="#compress-fasta-files"><code>agc-compress</code></a> and <a href="#align-assemblies"><code>align-assemblies</code></a> commands).</td>
</tr>
<tr>
<td><code>2</code></td>
<td>Name of the sample that will be (1) appended to each header line and (2) the name of the newly generated FASTA file.</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>My example <code>annotation_keyfile.txt</code> (which is placed in the 
  <code>data/</code> subdirectory) would look like this:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>data/Ref-v5.fa<span class="w"> </span>Ref
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>data/LineA-final-01.fa<span class="w">   </span>LineA
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>data/LineB-final-04.fa<span class="w">   </span>LineB
</span></code></pre></div>
</li>
<li>
<blockquote>
<p>⚠️ <strong>Warning</strong><br />
<strong>All</strong> sample assemblies (<strong>including your reference assembly</strong>)
  that you would want processed need to be included in this keyfile.</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p><code>--threads</code> - Optional number of threads to update multiple
  FASTA files in parallel. <em>Defaults to <code>1</code></em>.</p>
</li>
<li><code>-o</code> - Output directory for the newly updated FASTA files</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>FASTA input files can be either uncompressed or compressed. The
output from the <code>prepare-assemblies</code> command will be new FASTA files
that are <strong>uncompressed</strong>.  While AGC accepts compressed FASTA
files, the <code>align-assemblies</code> command uses
<a href="https://github.com/baoxingsong/AnchorWave">AnchorWave</a> which
requires uncompressed FASTA files.</p>
</div>
<p>Once finished, this command will produce FASTA files with the name
of the sample from the keyfile appended to each header line. For
example, in our hypothetical FASTA files, our headers go from this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>$ head LineA.fa
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>&gt;chr1
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>ATGCGTACGCGCACCG
</span></code></pre></div>
<p>to this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>$ head LineA.fa
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>&gt;chr1 sampleName=LineA
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>ATGCGTACGCGCACCG
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This command will just append the name of a file to the end of the
FASTA headers. For example, if we had a more detailed header:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>chr1 pos=1:16
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>ATGCGTACGCGCACCG
</span></code></pre></div>
<p>...the header would become:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>chr1 pos=1:16 sampleName=LineA
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>ATGCGTACGCGCACCG
</span></code></pre></div>
</div>
<p>Now that we are finished preparing samples, my example working
directory looks like the following with a newly formed subdirectory
called <code>updated_assemblies</code> under the <code>output</code> directory:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>phg_v2_example/
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>├── data
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>│   ├── anchors.gff
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>│   ├── annotation_keyfile.txt *
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>│   ├── Ref-v5.fa
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>│   ├── LineA-final-01.fa
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>│   └── LineB-final-04.fa
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>├── output
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>│   ├── updated_assemblies *
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>│   │   ├── Ref.fa *
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>│   │   ├── LineA.fa *
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>│   │   └── LineB.fa *
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>└── vcf_dbs
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>    ├── gvcf_dataset/
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>    ├── hvcf_dataset/
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a>    └── temp/
</span></code></pre></div>
<p>For further steps, we will be using the updated assemblies from the
<code>output/updated_assemblies</code> directory path.</p>
<h3 id="compress-fasta-files">Compress FASTA files<a class="headerlink" href="#compress-fasta-files" title="Permanent link">&para;</a></h3>
<p>For optimal storage of sequence information, we can convert our
"plain-text" FASTA files into a more compact representation using
compression. For PHGv2, we can use a command called <code>agc-compress</code>,
which is a wrapper for the
<a href="https://github.com/refresh-bio/agc">Assembled Genomes Compressor</a>
(AGC). AGC provides performant and efficient compression ratios for
our assembly genomes. Like AnchorWave, AGC is also installed during
the Conda environment setup phase, so there is no need to install
this manually.</p>
<p>To run the compression step, we can call the <code>agc-compress</code>
command:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>./phg<span class="w"> </span>agc-compress<span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span>--db-path<span class="w"> </span>vcf_dbs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span>--fasta-list<span class="w"> </span>data/assemblies_list.txt<span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span>--reference-file<span class="w"> </span>output/updated_assemblies/Ref.fa<span class="w"> </span><span class="se">\</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">    </span>--conda-env-prefix<span class="w"> </span>/path/to/conda/env
</span></code></pre></div>
<p>This command takes in 3 parameters:
* <code>--db-path</code> - path to directory storing the TileDB instances. The
  AGC compressed genomes will be placed here on completion.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The directory specified here should be the same directory used to
initialize the TileDB instances in the database initialization
(<code>initdb</code>) step.</p>
</div>
<ul>
<li><code>--fasta-list</code> - List of annotated assembly FASTA genomes to
  compress.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The list specified in <code>--fasta-list</code> should be the list of FASTA
files output from the <code>prepare-assemblies</code> command (<em>see the
<a href="#prepare-assembly-fasta-files">"Prepare Assembly FASTA files"</a> section for
further details</em>).</p>
</div>
<ul>
<li><code>--reference-file</code> - Reference FASTA genome processed with
  the <code>prepare-assemblies</code> command.</li>
</ul>
<p>In addition, <code>conda-env-prefix</code> is an optional parameter that specifies the path
to the Conda directory that contains the conda environment needed to run phg.
If not set, conda env <code>phgv2-conda</code> in the defauilt location will be used.</p>
<p>After compression is finished, we can navigate to the directory
containing the TileDB instances. In my case, this would be the
subdirectory, <code>vcf_dbs</code>. Here, you will see a new file created:
<code>assemblies.agc</code>. This is the compressed AGC file containing our
assemblies. This file will be used later to query for haplotype
sequence regions and composite genome creation. Our example
working directory now looks like this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>phg_v2_example/
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>├── data
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>│   ├── anchors.gff
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>│   ├── annotation_keyfile.txt
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>│   ├── Ref-v5.fa
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>│   ├── LineA-final-01.fa
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>│   └── LineB-final-04.fa
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>├── output
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>│   └── updated_assemblies
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>│       ├── Ref.fa
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>│       ├── LineA.fa
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>│       └── LineB.fa
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>└── vcf_dbs
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>    ├── assemblies.agc *
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>    ├── gvcf_dataset/
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>    ├── hvcf_dataset/
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>    └── temp/
</span></code></pre></div>
<p>When running the <code>agc-compress</code> command, the software will
determine if the "create" or "append" AGC command should be used.
If the <code>assemblies.agc</code> file is not present in the db-path directory,
the software will use the "create" command to compress and load the
FASTAs. If the <code>assemblies.agc</code> file is present in the db-path
directory, the software will use the "append" command to compress and
load the FASTAs to the existing <code>assemblies.agc</code> file. It skips FASTA
files whose "name" portion (file name without extension) is already
represented as a sample name in the <code>assemblies.agc</code> file, adding only
the new FASTAs to this file.</p>
<h3 id="create-reference-ranges">Create reference ranges<a class="headerlink" href="#create-reference-ranges" title="Permanent link">&para;</a></h3>
<p>Next, we must define ordered sequences of genic and inter-genic 
ranges across the reference genome. These ordered ranges, which we 
will call "reference ranges", are used to specify haplotype sequence 
coordinate information for the haplotype and genomic variant call 
format data. These genomic positions are structured using the 
<a href="https://en.wikipedia.org/wiki/BED_(file_format)">BED</a> format.</p>
<p>Generally, this data is not readily available as BED files. PHGv2
can generate this file directly from 
<a href="https://en.wikipedia.org/wiki/General_feature_format">GFF</a>-formatted 
data using the <code>create-ranges</code> command:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>./phg<span class="w"> </span>create-ranges<span class="w"> </span><span class="se">\</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="w">    </span>--gff<span class="w"> </span>data/anchors.gff<span class="w"> </span><span class="se">\</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">    </span>--reference-file<span class="w"> </span>output/updated_assemblies/Ref.fa<span class="w"> </span><span class="se">\</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">    </span>--boundary<span class="w"> </span>gene<span class="w"> </span><span class="se">\</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">    </span>--pad<span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">    </span>--range-min-size<span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">    </span>-o<span class="w"> </span>output/ref_ranges.bed
</span></code></pre></div>
<p>This command uses several parameters:</p>
<ul>
<li><code>--gff</code> - Our reference GFF file of interest. Since 
  reference ranges are usually established by genic/intergenic 
  regions, we can leverage coordinate and feature information from
  GFF files.</li>
<li><code>--reference-file</code> - Our reference genome in 
  <a href="https://en.wikipedia.org/wiki/FASTA_format">FASTA</a> format. This
  is needed for determining the intergenic regions near the ends of 
  chromosomes.</li>
<li>
<p><code>--boundary</code> - How do you want to define the boundaries of the 
  reference ranges. Currently, these can be defined as either
  <code>gene</code> or <code>cds</code> regions:</p>
<p><img alt="" src="../img/build_and_load/create_ranges_01.svg" /></p>
<ul>
<li>In the above figure, if <code>--boundary</code> is set to <code>gene</code>, the start
  and end positions are at the UTR regions for each gene feature from
  the GFF file, while <code>cds</code> will begin and end at the open reading 
  frame. By default, the <code>cds</code> option will try to identify the
  transcript with the longest open reading frame if there are
  multiple transcript "children" for a gene "parent" in the GFF
  file.</li>
</ul>
</li>
<li>
<p><code>--pad</code> - The number of base pairs you would like to flank regions:</p>
<p><img alt="" src="../img/build_and_load/create_ranges_02.svg" /></p>
<ul>
<li>For example, if we were to set the <code>--pad</code> parameter to <code>500</code>,
  we would extend the region 500 base pairs upstream and downstream
  of the defined boundary (in this case, <code>gene</code>).</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is a possibility that overlaps of regions will occur. If
this does happen, <code>create-ranges</code> will identify any overlapping
regions and merge regions together:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>[---Overlap 1----]
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>           [-------Overlap 2-------]
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>====================================
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>[---------Merged overlap-----------]
</span></code></pre></div>
</div>
<ul>
<li><code>--range-min-size</code> - The minimum size for each range in the BED 
  file. This parameter is optional with a default of 500 base pairs. 
  For example, if we were to set the <code>--range-min-size</code> parameter to 
  <code>500</code>, any region that is less than 500 base pairs in length will 
  be merged with the previous region on that contig.  If the first 
  region of a contig is less than the specified minimum size, it will 
  be merged with the next region on that contig.  This merging is 
  done in <code>create-ranges</code> after the gene or CDS region has been 
  created and padding has been applied.</li>
<li><code>-o</code> - Name for the output BED file.</li>
</ul>
<p>In the above example, I am using test data from the 
<a href="https://github.com/maize-genetics/phg_v2/tree/main/data/test/smallseq">PHGv2 GitHub repository</a>.
After the command is finished, we have produced a BED file (which
in my case, is located in a subdirectory labelled <code>output</code>). This BED 
file contains 6 columns of information:</p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1</code></td>
<td>Sequence name</td>
</tr>
<tr>
<td><code>2</code></td>
<td>Start position (bp)</td>
</tr>
<tr>
<td><code>3</code></td>
<td>End position (bp)</td>
</tr>
<tr>
<td><code>4</code></td>
<td>Range ID</td>
</tr>
<tr>
<td><code>5</code></td>
<td>Score (always <code>0</code>)</td>
</tr>
<tr>
<td><code>6</code></td>
<td>Strand information</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Column <code>4</code> will either be gene or cds name depending on the boundary
input.  If regions overlapped and were merged, the name is a comma 
separated string of all the genes/CDS features included in this BED 
region.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While a BED file of reference ranges is required for this 
pipeline, it does not have to be created via the <code>create-ranges</code> 
command as long as it is reflective of the features found within 
the reference genome used in the pipeline:</p>
<ul>
<li>Same contig/chromosome IDs</li>
<li>Coordinates are <a href="https://tidyomics.com/blog/2018/12/09/2018-12-09-the-devil-0-and-1-coordinate-system-in-genomics/"><strong>0-based, inclusive/exclusive</strong></a></li>
<li>Coordinates do <strong>not</strong> exceed contig boundaries</li>
<li>Coordinates do <strong>not</strong> overlap</li>
<li>Contains the first three BED columns:<ul>
<li><code>1</code> - Sequence name</li>
<li><code>2</code> - Start position (bp)</li>
<li><code>3</code> - End position (bp)</li>
</ul>
</li>
</ul>
<p>While we only need the first three columns, columns <code>4</code> through
<code>6</code> provide additional biologically relevant information that
you <em>may</em> also want to include!</p>
</div>
<p>Now that we have a BED file, our example working directory now
looks like the following:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>phg_v2_example/
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>├── data
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>│   ├── anchors.gff
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>│   ├── annotation_keyfile.txt
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>│   ├── Ref-v5.fa
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>│   ├── LineA-final-01.fa
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>│   └── LineB-final-04.fa
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>├── output
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>│   ├── ref_ranges.bed *
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>│   └── updated_assemblies
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>│       ├── Ref.fa
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>│       ├── LineA.fa
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>│       └── LineB.fa
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>└── vcf_dbs
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>    ├── assemblies.agc
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>    ├── gvcf_dataset/
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>    ├── hvcf_dataset/
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>    └── temp/
</span></code></pre></div>
<h3 id="align-assemblies">Align assemblies<a class="headerlink" href="#align-assemblies" title="Permanent link">&para;</a></h3>
<p>Next, we must align our collection of genome assemblies against a
single reference genome in order to have a common coordinate system
across all genomes within our PHG databases. While whole genome
alignment can be performed in a multitude of ways, PHGv2 provides an
opinionated wrapper to <a href="https://doi.org/10.1073/pnas.2113075119">AnchorWave</a>, 
which uses an <strong>Anchor</strong>ed <strong>Wave</strong>front alignment approach for 
genomes with high sequence diversity, extensive structural 
polymorphism, or whole-genome duplications. Since this software is
already set up during the Conda environment step, there is no need
to install this manually.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For best results with imputation and rare allele calling pipelines, 
<strong>please use high quality assemblies</strong> that have been run through 
the <code>prepare-assemblies</code> command.</p>
</div>
<p>To run the aligner step, we can call the <code>align-assemblies</code> command:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>./phg<span class="w"> </span>align-assemblies<span class="w"> </span><span class="se">\</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="w">    </span>--gff<span class="w"> </span>data/anchors.gff<span class="w"> </span><span class="se">\</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">    </span>--reference-file<span class="w"> </span>output/updated_assemblies/Ref.fa<span class="w"> </span><span class="se">\</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">    </span>--assembly-file-list<span class="w"> </span>data/assemblies_list.txt<span class="w"> </span><span class="se">\</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">    </span>--total-threads<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">    </span>--in-parallel<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">    </span>-o<span class="w"> </span>output/alignment_files<span class="w"> </span><span class="se">\</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">    </span>--conda-env-prefix<span class="w"> </span>/path/to/conda/env
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following example workflow is for users who have access to a
<strong>single machine</strong>. If you are running this on an 
<a href="https://en.wikipedia.org/wiki/High-performance_computing">HPC</a>
system that leverages the 
<a href="https://en.wikipedia.org/wiki/Slurm_Workload_Manager">SLURM</a>
job scheduler, <strong>please follow the guidelines found in the 
<a href="../slurm_usage/">"SLURM Usage"</a> documentation</strong> to maximize
computational efficiency.</p>
</div>
<h4 id="align-assemblies-parameters">Align-assemblies parameters<a class="headerlink" href="#align-assemblies-parameters" title="Permanent link">&para;</a></h4>
<p>This <code>align-assemblies</code> command uses several <strong>required</strong> parameters:</p>
<ul>
<li><code>--gff</code> - GFF file for the reference genome. This is used to
  identify full-length coding sequences to use as anchors</li>
<li>
<p><code>--reference-file</code> - The reference genome in 
  <a href="https://en.wikipedia.org/wiki/FASTA_format">FASTA</a> format.</p>
<ul>
<li>
<blockquote>
<p>ℹ️ <strong>Note</strong><br />
  The path to the reference genome should be the <strong>updated version</strong>
  that was created during the <code>prepare-assemblies</code> command.</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p><code>--assembly-file-list</code> Or <code>--assembly-file</code> - Either a single 
  annotated file may be specified, or a text file containing a list 
  of <strong>annotated</strong> assembly genomes (<em>see the <a href="#prepare-assembly-fasta-files">"Prepare Assembly FASTA files"</a> 
  section for further details</em>). The single assembly or the contents 
  of the assembly list file should be either full or relative paths
  to each uncompressed assembly you would like to align.
  For example, since I am using the example data found on the 
  <a href="https://github.com/maize-genetics/phg_v2/tree/main/data/test/smallseq">PHGv2 GitHub repository</a>,
  I can create a text file called <code>assemblies_list.txt</code> (placed in 
  the <code>data/</code> subdirectory) and populate it with the following lines:</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>output/updated_assemblies/LineA.fa
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>output/updated_assemblies/LineB.fa
</span></code></pre></div>
Here, I am planning on aligning two genomes called <code>LineA</code> and 
<code>LineB</code>. Since these are created with the <code>prepare-assemblies</code> command 
and the output is located in a subdirectory called 
<code>output/updated_assemblies/</code> relative to my working directory, I 
will also add that to the path.</p>
<ul>
<li>
<blockquote>
<p>⚠️ <strong>Warning</strong><br />
  This text list <strong>should not</strong> contain the path to the reference
  genome since this is recognized in the <code>--reference-file</code> flag.</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p><code>-o</code> - The name of the directory for the alignment outputs.</p>
</li>
</ul>
<h4 id="align-assemblies-optional-parameters">Align-assemblies <em>optional</em> parameters<a class="headerlink" href="#align-assemblies-optional-parameters" title="Permanent link">&para;</a></h4>
<p>In addition to the above parameters, there are several <strong><em>optional</em></strong> 
parameters. When values are not specified for these parameters,
default values are calculated by the software based on the system 
processor and memory configuration:</p>
<ul>
<li><code>--total-threads</code> - How many threads would you like to allocate for
  the alignment step? More information about this step and the 
  <code>--in-parallel</code> step can be found in the following 
  <a href="#details-threads-and-parallelization">Details - threads and parallelization</a> 
  section.</li>
<li><code>--in-parallel</code> - How many genomes would you like to run in 
  parallel? More information about this step and the <code>--total-threads</code> 
  step can be found in the following 
  <a href="#details-threads-and-parallelization">"Details - threads and parallelization"</a> 
  section.</li>
<li><code>--conda-env-prefix</code> - Specifies the path to the Conda directory 
  that contains the Conda environment needed to run the PHG software. 
  If not set, a Conda environment labelled <code>phgv2-conda</code> will be used 
  in the default location.</li>
<li><code>--just-ref-prep</code> - Specifies whether to run only the preliminary 
  steps of aligning the reference genome to the GFF CDS, creating the 
  <code>reference-sam</code> and <code>reference-cds-fasta</code> files needed for aligning 
  the individual assemblies. This is desirable when a list of assembly 
  files will be run through a SLURM job, and we don't want to 
  unnecessarily create these 2 files multiple times. If set to <code>true</code>, 
  the software stops after creating these two files, which will be 
  written to the user supplied output directory. The default value is 
  <code>false</code>. More information about these parameters can be found in the 
  supplemental <a href="../slurm_usage/">"SLURM Usage"</a> documentation.</li>
<li><code>--reference-sam</code> - If this is specified, the parameter 
  <code>--reference-cds-fasta</code> must also be supplied. When both are 
  supplied, the software skips the creation of these files and uses 
  those supplied by the user. This is desirable when the user is 
  running multiple assembly alignments from a SLURM data-array option 
  and does not wish to realign the reference multiple times. If 
  specified, but <code>--reference-cds-fasta</code> is not, <strong>the software will 
  throw an exception</strong>. More information about these parameters can be
  found in the supplemental <a href="../slurm_usage/">"SLURM Usage"</a> 
  documentation.</li>
<li><code>--reference-cds-fasta</code> - If this is specified, the parameter
  <code>--reference-sam</code> must also be supplied. When both are supplied, the 
  software skips the creation of these files and uses those supplied 
  by the user. This is desirable when the user is running multiple 
  assembly alignments from a SLURM data-array option and does not 
  wish to realign the reference multiple times. If specified, but 
  <code>--reference-sam</code> is not, <strong>the software will throw an exception</strong>. 
  More information about these parameters can be found in the 
  supplemental <a href="../slurm_usage/">"SLURM Usage"</a> documentation.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The directory that you specify in the output (<code>-o</code>) section must
be an existing directory.</p>
</div>
<p>Once alignment is finished, and you have navigated into the output 
directory (in my case, this would be <code>output/alignment_files</code>),
you will see several different file types. In addition to various 
logging files (<code>.log</code>) for the AnchorWave procedures, you will notice 
that each assembly will have a collection of different file types:</p>
<table>
<thead>
<tr>
<th>File extension</th>
<th>Property</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.sam</code></td>
<td><a href="https://en.wikipedia.org/wiki/SAM_(file_format)">sequence alignment map</a> (SAM) file</td>
</tr>
<tr>
<td><code>.maf</code></td>
<td><a href="https://genome.ucsc.edu/FAQ/FAQformat.html#format5">multiple alignment format</a> (MAF) file</td>
</tr>
<tr>
<td><code>.anchorspro</code></td>
<td>alignment blocks between reference and assembly genomes (used for dot plot generation)</td>
</tr>
</tbody>
</table>
<p>The MAF files from this output will be used in the VCF creation step. 
Additionally, <a href="https://en.wikipedia.org/wiki/Dot_plot_(bioinformatics)">dot plots</a> 
will be generated for each sample/reference alignment as <code>.svg</code> 
files. Now that alignment is completed, our example working directory 
looks as follows (<strong>NOTE</strong>: I will collapse <code>alignment_files</code> for 
future steps):</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>phg_v2_example/
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>├── data
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>│   ├── anchors.gff
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>│   ├── annotation_keyfile.txt
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>│   ├── assemblies_list.txt *
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>│   ├── Ref-v5.fa
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>│   ├── LineA-final-01.fa
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>│   └── LineB-final-04.fa
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>├── output
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>│   ├── alignment_files
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>│   │   ├── anchorwave_gff2seq_error.log *
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>│   │   ├── anchorwave_gff2seq_output.log *
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>│   │   ├── LineA.maf *
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>│   │   ├── LineA.sam *
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a>│   │   ├── LineA.svg *
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a>│   │   ├── LineA_Ref.anchorspro *
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a>│   │   ├── LineB.maf *
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a>│   │   ├── LineB.sam *
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a>│   │   ├── LineB.svg *
</span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a>│   │   ├── LineB_Ref.anchorspro *
</span><span id="__span-37-21"><a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a>│   │   ├── minimap2_LineA_error.log *
</span><span id="__span-37-22"><a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a>│   │   ├── minimap2_LineA_output.log *
</span><span id="__span-37-23"><a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a>│   │   ├── minimap2_LineB_error.log *
</span><span id="__span-37-24"><a id="__codelineno-37-24" name="__codelineno-37-24" href="#__codelineno-37-24"></a>│   │   ├── minimap2_LineB_output.log *
</span><span id="__span-37-25"><a id="__codelineno-37-25" name="__codelineno-37-25" href="#__codelineno-37-25"></a>│   │   ├── minimap2_Ref_error.log *
</span><span id="__span-37-26"><a id="__codelineno-37-26" name="__codelineno-37-26" href="#__codelineno-37-26"></a>│   │   ├── minimap2_Ref_output.log *
</span><span id="__span-37-27"><a id="__codelineno-37-27" name="__codelineno-37-27" href="#__codelineno-37-27"></a>│   │   ├── proali_LineA_outputAndError.log *
</span><span id="__span-37-28"><a id="__codelineno-37-28" name="__codelineno-37-28" href="#__codelineno-37-28"></a>│   │   ├── proali_LineB_outputAndError.log *
</span><span id="__span-37-29"><a id="__codelineno-37-29" name="__codelineno-37-29" href="#__codelineno-37-29"></a>│   │   ├── ref.cds.fasta *
</span><span id="__span-37-30"><a id="__codelineno-37-30" name="__codelineno-37-30" href="#__codelineno-37-30"></a>│   │   └── Ref.sam *
</span><span id="__span-37-31"><a id="__codelineno-37-31" name="__codelineno-37-31" href="#__codelineno-37-31"></a>│   ├── ref_ranges.bed
</span><span id="__span-37-32"><a id="__codelineno-37-32" name="__codelineno-37-32" href="#__codelineno-37-32"></a>│   └── updated_assemblies
</span><span id="__span-37-33"><a id="__codelineno-37-33" name="__codelineno-37-33" href="#__codelineno-37-33"></a>│       ├── Ref.fa
</span><span id="__span-37-34"><a id="__codelineno-37-34" name="__codelineno-37-34" href="#__codelineno-37-34"></a>│       ├── LineA.fa
</span><span id="__span-37-35"><a id="__codelineno-37-35" name="__codelineno-37-35" href="#__codelineno-37-35"></a>│       └── LineB.fa
</span><span id="__span-37-36"><a id="__codelineno-37-36" name="__codelineno-37-36" href="#__codelineno-37-36"></a>└── vcf_dbs
</span><span id="__span-37-37"><a id="__codelineno-37-37" name="__codelineno-37-37" href="#__codelineno-37-37"></a>    ├── gvcf_dataset/
</span><span id="__span-37-38"><a id="__codelineno-37-38" name="__codelineno-37-38" href="#__codelineno-37-38"></a>    ├── hvcf_dataset/
</span><span id="__span-37-39"><a id="__codelineno-37-39" name="__codelineno-37-39" href="#__codelineno-37-39"></a>    └── temp/
</span></code></pre></div>
<h4 id="internal-anchorwave-and-minimap2-commands">Internal AnchorWave and minimap2 commands<a class="headerlink" href="#internal-anchorwave-and-minimap2-commands" title="Permanent link">&para;</a></h4>
<p>While PHGv2 is flexible in terms of how data is processed, we have
taken several opinionated steps with how the AnchorWave aligner runs
in the <code>align-assemblies</code> command. If you are interested with what
parameters are utilized, search for <code>ProcessBuilder()</code> methods within
our <a href="https://github.com/maize-genetics/phg_v2/blob/main/src/main/kotlin/net/maizegenetics/phgv2/cli/AlignAssemblies.kt"><code>AlignAssemblies.kt</code> source code</a>
or review the following code blocks:</p>
<ul>
<li>Run AnchorWave's <code>gff2seq</code> command:
  <div class="language-shell highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1"># Get the longest full-length CDS for each gene</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>anchorwave<span class="w"> </span>gff2seq<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">    </span>-r<span class="w"> </span>&lt;<span class="s1">&#39;--reference-file&#39;</span><span class="w"> </span>parameter&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span>-i<span class="w"> </span>&lt;<span class="s1">&#39;--gff&#39;</span><span class="w"> </span>parameter&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">    </span>-o<span class="w"> </span>ref.cds.fasta<span class="w"> </span><span class="c1"># directed to &#39;-o&#39; path</span>
</span></code></pre></div></li>
<li>Run minimap2
  <div class="language-shell highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># AnchorWave liftover steps (ref CDS to query)</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>minimap2<span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">    </span>-x<span class="w"> </span><span class="s2">&quot;splice&quot;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="w">    </span>-t<span class="w"> </span>&lt;<span class="w"> </span><span class="s1">&#39;--total-threads&#39;</span><span class="w"> </span>parameter<span class="w"> </span>&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">    </span>-k<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="se">\ </span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">    </span>-a<span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">    </span>-p<span class="w"> </span><span class="m">0</span>.4<span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">    </span>-N<span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="w">    </span>&lt;<span class="s1">&#39;--reference-file&#39;</span><span class="w"> </span>parameter<span class="w"> </span>OR<span class="w"> </span>sample<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s1">&#39;--assemblies&#39;</span><span class="w"> </span>parameter&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="w">    </span>ref.cds.fasta<span class="w"> </span><span class="se">\ </span><span class="w">     </span><span class="c1"># from prior &#39;gff2seq&#39; step</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="w">    </span>-o<span class="w"> </span>&lt;sample_name&gt;.sam<span class="w"> </span><span class="c1"># directed to &#39;-o&#39; path</span>
</span></code></pre></div></li>
<li>Run AnchorWave's <code>proali</code> command:
  <div class="language-shell highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>anchorwave<span class="w"> </span>proali<span class="w"> </span><span class="se">\</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">    </span>-i<span class="w"> </span>&lt;<span class="s1">&#39;--gff&#39;</span><span class="w"> </span>parameter&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">    </span>-r<span class="w"> </span>&lt;<span class="s1">&#39;--reference-file&#39;</span><span class="w"> </span>parameter&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">    </span>-as<span class="w"> </span>ref.cds.fa<span class="w"> </span><span class="se">\</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">    </span>-a<span class="w"> </span>&lt;assembly_sample.sam&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">    </span>-ar<span class="w"> </span>&lt;ref_assembly.sam&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">    </span>-s<span class="w"> </span>&lt;assembly_sample.fa&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">    </span>-n<span class="w"> </span>&lt;assembly_ref.anchorspro&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">    </span>-R<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\ </span><span class="w">   </span><span class="c1"># manually set via --ref-max-align-cov</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="w">    </span>-Q<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\ </span><span class="w">   </span><span class="c1"># manually set via --query-max-align-cov</span>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="w">    </span>-t<span class="w"> </span>&lt;<span class="s1">&#39;--total-threads&#39;</span><span class="w"> </span>/<span class="w"> </span><span class="s1">&#39;--in-parallel&#39;</span><span class="w"> </span>parameter&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="w">    </span>-o<span class="w"> </span>&lt;assembly_sample.maf&gt;
</span></code></pre></div></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the above <code>proali</code> command, the maximum reference genome 
alignment coverage (<code>-R</code>) and maximum query genome coverage (<code>-Q</code>)
can be manually set using the <code>--ref-max-align-cov</code> and 
<code>--query-max-algin-cov</code> commands, respectively. If these are not
set, they will both default to the value of <code>1</code> as shown in the
prior <code>-R</code> and <code>-Q</code> parameters.</p>
</div>
<h4 id="details-threads-and-parallelization">Details - threads and parallelization<a class="headerlink" href="#details-threads-and-parallelization" title="Permanent link">&para;</a></h4>
<p>Aligning with AnchorWave is memory intensive and can be slow. 
Processing speed may be increased by using multiple threads for each 
alignment, and/or by running multiple alignments in parallel. The 
amount of memory each thread takes is dependent on the processor 
type. The table below shows the memory usage for a single alignment 
based on processor type:</p>
<table>
<thead>
<tr>
<th>Processor</th>
<th>peak memory (GB)</th>
<th>wall time</th>
</tr>
</thead>
<tbody>
<tr>
<td>SSE2</td>
<td>20.1</td>
<td>26:47:17</td>
</tr>
<tr>
<td>SSE4.1</td>
<td>20.6</td>
<td>24:05:07</td>
</tr>
<tr>
<td>AVX2</td>
<td>20.1</td>
<td>21:40:00</td>
</tr>
<tr>
<td>AVX512</td>
<td>20.1</td>
<td>18:31:39</td>
</tr>
<tr>
<td>ARM</td>
<td>34.2</td>
<td>18:08:57</td>
</tr>
</tbody>
</table>
<p>The <code>--total-threads</code> parameter indicates the total number of threads 
available for system use. The <code>--in-parallel</code> parameter controls the 
number of alignments run in parallel.  When these values are not 
specified, the software will compute the optimal values based on the 
system processor and memory configuration. </p>
<p>The number of threads that may be run in parallel is limited by the 
amount of memory available. The system is queried for memory and 
processor information. The number of threads that may be run in 
parallel is determined by "system memory" / "peak memory" from the 
table above. To generalize the calculation, we divide memory 
available (GiB) by 21 and round down to the nearest integer.</p>
<p>For example, if the system has 512 GB of memory, 80 processors and 5 
assemblies that need aligning, the maximum number of threads that
could be run in parallel is 24 (512/21). The number of potential 
parallel alignments with the threads allocated for each is shown in 
the table below:</p>
<table>
<thead>
<tr>
<th>Alignments in parallel</th>
<th>Threads per alignment</th>
</tr>
</thead>
<tbody>
<tr>
<td>5</td>
<td>4</td>
</tr>
<tr>
<td>4</td>
<td>6</td>
</tr>
<tr>
<td>3</td>
<td>8</td>
</tr>
<tr>
<td>2</td>
<td>12</td>
</tr>
<tr>
<td>1</td>
<td>24</td>
</tr>
</tbody>
</table>
<p>The software will select a pairing that maximizes the number of 
alignments run in parallel while utilizing multiple threads, opting 
for a value in the middle. In the case above with 5 assemblies and a 
possibility of 24 concurrent threads, the system will choose to run 3 
alignments in parallel with 8 threads each.  The total number of 
threads used will be 24 (3 * 8).</p>
<p>User defined values for in-parallel and total-threads are considered 
along with the number of assemblies to align and system capacities, 
when determining the AnchorWave setup.</p>
<h3 id="create-vcf-files">Create VCF files<a class="headerlink" href="#create-vcf-files" title="Permanent link">&para;</a></h3>
<p>Now that we have (1) created alignments of our assemblies against a
single reference genome and (2) created compressed representations
of our assembly genomes, we can now create VCF information to
populate our TileDB instances. This process is performed using two
commands:</p>
<ol>
<li>Create hVCF data from reference genome:</li>
</ol>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>phg<span class="w"> </span>create-ref-vcf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">    </span>--bed<span class="w"> </span>output/ref_ranges.bed<span class="w"> </span><span class="se">\</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">    </span>--reference-file<span class="w"> </span>output/updated_assemblies/Ref.fa<span class="w"> </span><span class="se">\</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">    </span>--reference-name<span class="w"> </span>Ref<span class="w"> </span><span class="se">\</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">    </span>--db-path<span class="w"> </span>vcf_dbs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">    </span>--conda-env-prefix<span class="w"> </span>/path/to/conda/env
</span></code></pre></div>
<ol>
<li>Create hVCF and gVCF data from assembly alignments against reference
   genome:</li>
</ol>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>phg<span class="w"> </span>create-maf-vcf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="w">    </span>--db-path<span class="w"> </span>vcf_dbs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">    </span>--bed<span class="w"> </span>output/ref_ranges.bed<span class="w"> </span><span class="se">\</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">    </span>--reference-file<span class="w"> </span>output/updated_assemblies/Ref.fa<span class="w"> </span><span class="se">\</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">    </span>--maf-dir<span class="w"> </span>output/alignment_files<span class="w"> </span><span class="se">\</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">    </span>-o<span class="w"> </span>output/vcf_files<span class="w"> </span><span class="se">\</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">    </span>--conda-env-prefix<span class="w"> </span>/path/to/conda/env
</span></code></pre></div>
<ol>
<li><strong>(OPTIONAL!)</strong> Create hVCF from existing PHGv1 created gVCF files. 
   Use instead of create-maf-vcf if you have previously created gVCF 
   files from PHGv1 and want to create hVCF files:</li>
</ol>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>phg<span class="w"> </span>gvcf2hvcf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="w">    </span>--db-path<span class="w"> </span>vcf_dbs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">    </span>--bed<span class="w"> </span>output/ref_ranges.bed<span class="w"> </span><span class="se">\</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span>--reference-file<span class="w"> </span>output/updated_assemblies/Ref.fa<span class="w"> </span><span class="se">\</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">    </span>--gvcf-dir<span class="w"> </span>output/gvcf_files<span class="w"> </span>
</span></code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For more information about the haplotype VCF (hVCF) specification,
please refer to the <a href="../hvcf_specifications/">hVCF specification documentation</a>.</p>
</div>
<p>VCF creation is split up into two separate commands since the
reference genome and aligned assemblies require different sets of
input data. An additional optional command is available to convert
existing PHG created gVCF files to hVCF files:</p>
<h4 id="inputs-for-the-create-ref-vcf-command">Inputs for the <code>create-ref-vcf</code> command<a class="headerlink" href="#inputs-for-the-create-ref-vcf-command" title="Permanent link">&para;</a></h4>
<ul>
<li><code>--bed</code> - a BED file containing ordered reference ranges (<em>see
  the <a href="#create-reference-ranges">"Create reference ranges"</a> section for further 
  details</em>). This is used to define the positional information of the 
  VCF.</li>
<li><code>--reference-file</code> - processed reference FASTA genome (from 
  <code>prepare-assemblies</code>) used for creating MD5 hashes of sequence 
  information guided by reference range positional data from the 
  BED file used in the <code>--bed</code> parameter.</li>
<li><code>--reference-name</code> - the name of the reference sample. <ul>
<li>
<blockquote>
<p>ℹ️ <strong>Note</strong><br />
  The name given here should be the same name given in the
  keyfile during the <a href="#prepare-assembly-fasta-files">Prepare Assembly FASTA Files</a>
  step.</p>
</blockquote>
</li>
</ul>
</li>
<li><code>--db-path</code> - path to PHG database directory for VCF storage.</li>
</ul>
<p>OPTIONAL parameters:
There are 2 optional parameters to <code>create-ref-vcf</code>:</p>
<ul>
<li><code>--reference-url</code> - URL where the reference FASTA file can be
  downloaded. This will be added to the VCF header information.</li>
<li><code>--conda-env-prefix</code> - path to the Conda directory that contains the conda environment needed to run phg.  If not set, env <code>phgv2-conda</code> in the defauilt location will be used.</li>
</ul>
<p>Once the command is complete, and you have navigated into the 
<code>--db-path</code> parameter directory (in my case, <code>vcf_dbs/</code>), you will 
see a subfolder named <code>hvcf_files</code> with two files:</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;ref_name&gt;.h.vcf.gz</code></td>
<td>compressed reference haplotype VCF (hVCF) file</td>
</tr>
<tr>
<td><code>&lt;ref_name&gt;.h.vcf.gz.csi</code></td>
<td>coordinate sorted index (CSI) of the reference hVCF file</td>
</tr>
</tbody>
</table>
<p>Here, <code>&lt;ref_name&gt;</code> is the name of the reference genome provided
using the <code>--reference-name</code> parameter. Since I defined this
parameter as <code>Ref</code> in the above example, my two files would be:</p>
<ul>
<li><code>Ref.h.vcf.gz</code></li>
<li><code>Ref.h.vcf.gz.csi</code></li>
</ul>
<p>There will also be a subdirectory named <code>reference</code> with two files. 
The bed file used to create the reference hVCF and the reference 
FASTA are stored here for future reference.</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;ref_name&gt;.bed</code></td>
<td>BED file used to create the reference hVCF</td>
</tr>
<tr>
<td><code>&lt;ref_name&gt;.fa</code></td>
<td>reference FASTA file</td>
</tr>
</tbody>
</table>
<p>In addition to creating the files, the <code>create-ref-vcf</code> command will load the
reference hVCF file to the <code>hvcf_dataset</code> TileDB instance.</p>
<h4 id="inputs-for-the-create-maf-vcf-command">Inputs for the <code>create-maf-vcf</code> command<a class="headerlink" href="#inputs-for-the-create-maf-vcf-command" title="Permanent link">&para;</a></h4>
<ul>
<li><code>--db-path</code> - Path to the directory containing the TileDB 
  instances. This is needed to access the AGC compressed assembly
  genome information found in the <code>assemblies.agc</code> file (<em>see the 
  <a href="#compress-fasta-files">"Compress FASTA files"</a> section for further details</em>).</li>
<li><code>--bed</code> - A BED file containing ordered reference ranges (<em>see
  the <a href="#create-reference-ranges">"Create reference ranges"</a> section for further 
  details</em>). This is used to define the positional information of the 
  VCF in relation to the reference genome.</li>
<li><code>--reference-file</code> - Reference FASTA genome used for creating
  MD5 hashes of sequence information guided by reference range
  positional data from the BED file used in the <code>--bed</code> parameter.
  hashed sequence data will place in the <code>##ALT</code> tag's <code>RefRange</code>
  key.<ul>
<li>
<blockquote>
<p>ℹ️ <strong>Note</strong><br />
  This should be the processed reference assembly generated from
  the <a href="#prepare-assembly-fasta-files">"Prepare Assembly FASTA Files"</a>
  step.</p>
</blockquote>
</li>
</ul>
</li>
<li><code>--maf-dir</code> - Directory containing the MAF files generated using
  the <code>align-assemblies</code> command (<em>see the 
  <a href="#align-assemblies">"Align assemblies"</a> section for further 
  details</em>).</li>
<li><code>-o</code> - Output directory for the VCF data.</li>
</ul>
<p><code>create-maf-vcf</code> provides two <strong>optional</strong> parameters for metrics 
data (<em>see the <strong><a href="../qc_metrics/">"QC Metrics"</a></strong> documentation for
further information</em>):</p>
<ul>
<li><code>--metrics-file</code> - Name of the output file for the VCF metrics table
    if left blank, the table will be written to the output directory
    and will be named <code>VCFMetrics.tsv</code>.</li>
<li><code>--skip-metrics</code> - If this flag is set, QC metrics will not be 
  calculated</li>
</ul>
<p>In addition, <code>--conda-env-prefix</code> is an optional parameter that specifies the path
to the Conda directory that contains the conda environment needed to run phg.
If not set, conda env <code>phgv2-conda</code> in the defauilt location will be used.</p>
<p>There is also an optional parameter: <code>--legacy-maf-file</code>.  This flag can be added to the command
to be able to process MAF files created from anchorwave 1.2.2 or earlier.  If this is not set and 
an old file is being processed, the Assembly coordinates in the GVCF will be incorrect.</p>
<p>Once the command is complete, and you have navigated into the output
directory (in my case, <code>output/vcf_files</code>), you will see a collection
of different file types for each sample:</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;sample_name&gt;.h.vcf.gz</code></td>
<td>compressed reference <a href="../hvcf_specifications/">haplotype VCF</a> (hVCF) file</td>
</tr>
<tr>
<td><code>&lt;sample_name&gt;.h.vcf.gz.csi</code></td>
<td>coordinate sorted index (CSI) of the reference hVCF file</td>
</tr>
<tr>
<td><code>&lt;sample_name&gt;.g.vcf.gz</code></td>
<td>compressed reference genomic VCF (gVCF) file</td>
</tr>
<tr>
<td><code>&lt;sample_name&gt;.g.vcf.gz.csi</code></td>
<td>coordinate sorted index (CSI) of the reference gVCF file</td>
</tr>
</tbody>
</table>
<p>Here, <code>&lt;sample_name&gt;</code> would be the name of each sample that was
aligned to the reference genome.</p>
<h4 id="inputs-for-the-gvcf2hvcf-command-optional">Inputs for the <code>gvcf2hvcf</code> command (OPTIONAL!)<a class="headerlink" href="#inputs-for-the-gvcf2hvcf-command-optional" title="Permanent link">&para;</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>gvcf2hvcf</code> command should only be used if you have preexisting
gVCF data created from historic PHGv1 steps!</p>
</div>
<ul>
<li><code>--db-path</code> - Path to the directory containing the TileDB
  instances. This is needed to access the AGC compressed assembly
  genome information found in the <code>assemblies.agc</code> file (<em>see the
  <a href="#compress-fasta-files">"Compress FASTA files"</a> section for further details</em>).</li>
<li><code>--bed</code> - A BED file containing ordered reference ranges (<em>see
  the <a href="#create-reference-ranges">"Create reference ranges"</a> section for further
  details</em>). This is used to define the positional information of the
  VCF in relation to the reference genome.</li>
<li><code>--reference-file</code> - Reference FASTA genome used for creating
  MD5 hashes of sequence information guided by reference range
  positional data from the BED file used in the <code>--bed</code> parameter.
  hashed sequence data will place in the <code>##ALT</code> tag's <code>RefRange</code>
  key.</li>
<li><code>--gvcf-dir</code> - Directory containing gVCF files generated from either
  a PHGv1 <code>MAFToGVCFPlugin</code>  command or a BioKotlin 
  <code>MAFToGVCF.createGVCFfromMAF()</code> command.</li>
</ul>
<p>Now that we have created our hVCF and gVCF files using the 
<code>create-ref-vcf</code> and <code>create-maf-vcf</code> commands, our directory 
structure now looks like the following:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>phg_v2_example/
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>├── data
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>│   ├── anchors.gff
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>│   ├── annotation_keyfile.txt
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>│   ├── assemblies_list.txt
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>│   ├── Ref-v5.fa
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>│   ├── LineA-final-01.fa
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>│   └── LineB-final-04.fa
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>├── output
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>│   ├── alignment_files/
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>│   ├── ref_ranges.bed
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>│   ├── updated_assemblies
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>│   │   ├── Ref.fa
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>│   │   ├── LineA.fa
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>│   │   └── LineB.fa
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>│   └── vcf_files *
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>│       ├── LineA.h.vcf.gz *
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>│       ├── LineA.h.vcf.gz.csi *
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>│       ├── LineA.g.vcf.gz *
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>│       ├── LineA.g.vcf.gz.csi *
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>│       ├── LineB.h.vcf.gz *
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>│       ├── LineB.h.vcf.gz.csi *
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>│       ├── LineB.g.vcf.gz *
</span><span id="__span-44-24"><a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>│       ├── LineB.g.vcf.gz.csi *
</span><span id="__span-44-25"><a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>│       └── VCFMetrics.tsv *
</span><span id="__span-44-26"><a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a>└── vcf_dbs
</span><span id="__span-44-27"><a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a>    ├── assemblies.agc
</span><span id="__span-44-28"><a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a>    ├── gvcf_dataset/
</span><span id="__span-44-29"><a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a>    ├── hvcf_dataset/
</span><span id="__span-44-30"><a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>    ├── hvcf_files *
</span><span id="__span-44-31"><a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a>    │   ├── Ref.h.vcf.gz *
</span><span id="__span-44-32"><a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a>    │   └── Ref.h.vcf.gz.csi *
</span><span id="__span-44-33"><a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a>    ├── reference *
</span><span id="__span-44-34"><a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a>    │   ├── Ref.bed *
</span><span id="__span-44-35"><a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a>    │   └── Ref.fa *
</span><span id="__span-44-36"><a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a>    └── temp/
</span></code></pre></div>
<h3 id="load-vcf-data-into-dbs">Load VCF data into DBs<a class="headerlink" href="#load-vcf-data-into-dbs" title="Permanent link">&para;</a></h3>
<p>After VCF files are created, we can finally load the information
into our empty TileDB instances. Instead of manually performing this
action, we can use the <code>load-vcf</code> command to automatically load hVCF
and gVCF files into their respective TileDB directories:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>./phg<span class="w"> </span>load-vcf<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">    </span>--vcf-dir<span class="w"> </span>output/vcf_files<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">    </span>--db-path<span class="w"> </span>vcf_dbs<span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">    </span>--threads<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">    </span>--conda-env-prefix<span class="w"> </span>/path/to/conda/env
</span></code></pre></div>
<p>This command takes three parameters:</p>
<ul>
<li><code>--vcf-dir</code> - Directory containing <code>h.vcf.gz</code> and/or <code>g.vcf.gz</code> 
  files made from the <code>create-ref-vcf</code> and <code>create-maf-vcf</code> commands
  (<em>see the <a href="#create-vcf-files">"Create VCF files"</a> section for 
  further details</em>). In my example case this is a subdirectory
  called <code>output/vcf_files</code>.</li>
<li><code>--db-path</code> - Path to the directory containing the TileDB instances.</li>
<li><code>--threads</code> - Number of threads for use by the TileDB loading
  procedure.</li>
</ul>
<p>Optional Parameter:</p>
<ul>
<li><code>--conda-env-prefix</code> - path to the Conda directory that contains the conda environment needed to run phg.  If not set, env <code>phgv2-conda</code> in the defauilt location will be used.</li>
</ul>
<p>After VCF files have been loaded, the directory containing the TileDB
instances (in our case, <code>vcf_dbs/</code>) can be compressed for backups</p>
<h3 id="where-to-go-from-here">Where to go from here?<a class="headerlink" href="#where-to-go-from-here" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="../qc_metrics/">QC Metrics</a></li>
<li><a href="../imputation_ropebwt/">Imputation and Path Finding</a></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 - 2025  <a href="https://www.maizegenetics.net "><b>Buckler Lab</b></a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/maize-genetics" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/c/BucklerLab" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M549.7 124.1c-6.2-23.7-24.8-42.3-48.3-48.6C458.9 64 288.1 64 288.1 64S117.3 64 74.7 75.5c-23.5 6.3-42 24.9-48.3 48.6C15 167 15 256.4 15 256.4s0 89.4 11.4 132.3c6.3 23.6 24.8 41.5 48.3 47.8C117.3 448 288.1 448 288.1 448s170.8 0 213.4-11.5c23.5-6.3 42-24.2 48.3-47.8 11.4-42.9 11.4-132.3 11.4-132.3s0-89.4-11.4-132.3zM232.2 337.6V175.2l142.7 81.2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.select", "content.code.copy", "content.code.annotate", "navigation.tabs", "navigation.top", "navigation.sections", "navigation.indexes", "navigation.expand", "search.highlight"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../javascript/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>